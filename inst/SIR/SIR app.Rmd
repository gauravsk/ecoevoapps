---
title: "Compartmental infectious disease models"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

# library(tidyverse)
library(ggplot2)
library(tidyr)
library(purrr)
library(dplyr)
library(deSolve)
library(ecoevoapps)
library(patchwork)
library(kableExtra)

includeMarkdown("SIR_overview.md")
```

## Models Assuming Density-Dependent Transmission {.tabset}

All of the following disease models assume that infectious individuals mix homogenously with other individuals in the population and that infections occur in direct proportion to the number of encounters between susceptible and infectious individuals (i.e., *disease transmission is density-dependent* and happens at rate $\beta SI$).

*Open versus closed populations:* All of the models here include vital rates (i.e., births/deaths), which is called an open population. They assume that the number of births = the number of non-disease-induced deaths. If the course of the infection is short relative to individual lifespan, the vital rates can be ignored. Models that do not include vital rates are said to model a closed population. To run a model in this app without vital rates, set $m = 0$. 

### SIR model

\[
\begin{align}
\frac{dS}{dt} &= m(S + I + R)(1 - v) - mS - \beta SI\\
\frac{dI}{dt} &= \beta SI - mI - \gamma I\\
\frac{dR}{dt} &= \gamma I - mR + mv(S + I + R)
\end{align}
\]

```{r params SIR, echo=F}
pars_vars <- c("$S$", 
               "$I$", 
               "$R$", 
               "$m$", 
               "$\\beta$", 
               "$\\gamma$",
               "v")
descriptions <- c("Population size of susceptible individuals",
                 "Population size of infectious individuals",
                 "Population size of recovered individuals",
                 "Birth/death rate",
                 "Infection rate",
                 "Recovery rate",
                 "Newborn vaccination rate")
param_df <- data.frame(pars_vars, descriptions)
kable(x = param_df, format = "html", 
      col.names = c("Parameter/Variable", "Description")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed"),
                position = "center")
```  


```{r SIR app, echo=FALSE}
sidebarLayout(
  
  sidebarPanel(
    
    ### Ask user for parameter values ----
    
    #m - death/birth rate
    #beta - infection rate
    #gamma - recovery rate
    #v - vaccination rate
    
    sliderInput("m", label = "Birth/Death rate:",
                min = 0, max = 1, value = .1, step = 0.1),
    
    sliderInput("beta", label = "Infection rate:",
                min = 0, max = 1, value = .01, step = 0.01),
    
    sliderInput("gamma", label = "Recovery rate:",
                min = 0, max = 1, value = .2, step = 0.1),
    
    sliderInput("v", label = "Vaccination rate:",
                min = 0, max = 1, value = 0, step = 0.1),
    
    ### Ask user for initial conditions ----
    numericInput("S0", label = "Initial population size of S", min = 0, value = 100),
    numericInput("I0", label = "Initial population size of I", min = 0, value = 1),
    numericInput("R0", label = "Initial population size of R", min = 0, value = 0),
    
    ### Ask user for time to simulate ----
    numericInput("time", label = "Time to simulate", min = 10, value = 100)
    
    
  ),
  
  # Render plots -----------------
  mainPanel(renderPlot({plots_to_render_SIR()}, width = 600, height = 800))
  
)


# Run the simulation -------------------

# Set the initial population sizes
init <- reactive({c(S = input$S0, I = input$I0, R = input$R0)})
# Set the parameter values
params <- reactive({c(m = input$m, beta = input$beta, v = input$v, gamma = input$gamma)})
# Time over which to simulate model dynamics
time <- reactive({seq(0,input$time,by = .1)})

# Use the SIR function above to run 
# the SIR model using the 
# parameter estimates defined above
out <- reactive({data.frame(deSolve::ode(func = SIR,
                               y=init(), parms=params(), times = time()))})

# Reshape the data so that population sizes of both 
# species are in one column, and an extra column to define
# species name. This helps with the plotting...
out_long <- reactive({pivot_longer(out(), c(S, I, R), "group") %>% 
  mutate(group = factor(group, levels = c("S", "I", "R")))})

# use out to create dS, dI, dR, and the per capita changes in population
pop_out <- reactive({
  pop_out <- out()
  pop_out$dS <- c(NA, diff(pop_out$S))
  pop_out$dI <- c(NA, diff(pop_out$I))
  pop_out$dR <- c(NA, diff(pop_out$R))
  # not using pgrs right now but could be useful to calculate
  pop_out <- pop_out %>% mutate(pgrS = dS/S, pgrI = dI/I, pgrR = dR/R)
  pop_out
})

pop_out_long <- reactive({ pop_out() %>%
  select(time, dS, dI, dR) %>%
  pivot_longer(c(dS, dI, dR), "group") %>%
  mutate(group = factor(group, levels = c("dS", "dI", "dR")))
})

# Make plots --------------------


# Plot abundance through time ----------
abund_plot_SIR <- reactive({ggplot(out_long()) + 
    geom_line(aes(x = time, y = value, color = group), size = 2) + 
    scale_color_brewer(palette = "Set1") +
    ylab("Population size") + 
    ecoevoapps::theme_apps()
})

# # Plot dS, dI, dR over time
# dabund_plot_SIR <- reactive({ ggplot(pop_out_long()) +
#     geom_line(aes(x = time, y = value, color = group), size = 2) +
#     scale_color_brewer(palette = "Set1") +
#     ylab("Change in population size") +
#     ecoevoapps::theme_apps()
# })

# Plot S vs I ---------
SIplot <- reactive({ggplot(out()) +
    geom_segment(x = out()$S[round(length(time()))/25], 
                 y = out()$I[round(length(time()))/25], 
                 xend = out()$S[round(length(time())/25) + 1], 
                 yend = out()$I[round(length(time())/25) + 1], 
                 arrow = arrow(length = unit(0.15, "npc"))) +
    geom_path(aes(x = S, y = I), size = 2) +
    scale_color_brewer(palette = "Set1") +
    ylab("I size") +
    xlab("S size") +
    ecoevoapps::theme_apps()})

# Plot I vs R --------------
RIplot <- reactive({ggplot(out()) +
    geom_segment(x = out()$R[round(length(time()))/25], 
                 y = out()$I[round(length(time()))/25], 
                 xend = out()$R[round(length(time())/25) + 1], 
                 yend = out()$I[round(length(time())/25) + 1], 
                 arrow = arrow(length = unit(0.15, "npc"))) +
  geom_path(aes(x = R, y = I), size = 2) +
  scale_color_brewer(palette = "Set1") +
  ylab("I size") +
  xlab("R size") +
  ecoevoapps::theme_apps()})

# Plot S vs R ------------
SRplot <- reactive({ggplot(out()) +
    geom_segment(x = out()$S[round(length(time()))/25], 
                 y = out()$R[round(length(time()))/25], 
                 xend = out()$S[round(length(time())/25) + 1], 
                 yend = out()$R[round(length(time())/25) + 1], 
                 arrow = arrow(length = unit(0.15, "npc"))) +
  geom_path(aes(x = S, y = R), size = 2) +
  scale_color_brewer(palette = "Set1") +
  ylab("R size") +
  xlab("S size") +
  ecoevoapps::theme_apps()})

# combine 2d plots -----
SIR_2d_plots <- reactive({
  wrap_plots(SIplot(), RIplot(), SRplot(), ncol = 3)
})


# Make a list of plots and print out plots based on which ones were requested ----

plots_to_render_SIR <- reactive({
  wrap_plots(abund_plot_SIR(), 
             # dabund_plot_SIR(), 
             SIR_2d_plots(), nrow = 2) 
})


```



```{r SIR app no vitals, echo=FALSE, eval = FALSE}
## SIR model without vital rates

sidebarLayout(
  
  sidebarPanel(
    
    ### Ask user for parameter values ----
    
    #beta - infection rate
    #gamma - recovery rate
    #v - vaccination rate
    
    sliderInput("beta_sir_novitals", label = "Infection rate:",
                min = 0, max = 1, value = .01, step = 0.01),
    
    sliderInput("gamma_sir_novitals", label = "Recovery rate:",
                min = 0, max = 1, value = .2, step = 0.1),
    
    sliderInput("v_sir_novitals", label = "Vaccination rate:",
                min = 0, max = 1, value = 0, step = 0.1),
    
    ### Ask user for initial conditions ----
    numericInput("S0_sir_novitals", label = "Initial population size of S", min = 0, value = 100),
    numericInput("I0_sir_novitals", label = "Initial population size of I", min = 0, value = 1),
    numericInput("R0_sir_novitals", label = "Initial population size of R", min = 0, value = 0),
    
    ### Ask user for time to simulate ----
    numericInput("time_sir_novitals", label = "Time to simulate", min = 10, value = 100)
    
    
  ),
  
  # Render plots -----------------
  mainPanel(renderPlot({plots_to_render_SIR_sir_novitals()}, width = 600, height = 800))
  
)


# Run the simulation -------------------

# Set the initial population sizes
init_sir_novitals <- reactive({c(S = input$S0_sir_novitals, I = input$I0_sir_novitals, R = input$R0_sir_novitals)})
# Set the parameter values
params_sir_novitals <- reactive({c(m = input$m_sir_novitals, beta = input$beta_sir_novitals, v = input$v_sir_novitals, gamma = input$gamma_sir_novitals)})
# Time over which to simulate model dynamics
time_sir_novitals <- reactive({seq(0,input$time_sir_novitals,by = .1)})

# Use the SIR function above to run 
# the SIR model using the 
# parameter estimates defined above
out_sir_novitals <- reactive({data.frame(deSolve::ode(func = SIR_no_vitals,
                               y=init_sir_novitals(), parms=params_sir_novitals(), times = time_sir_novitals()))})

# Reshape the data so that population sizes of both 
# species are in one column, and an extra column to define
# species name. This helps with the plotting...
out_long_sir_novitals <- reactive({pivot_longer(out_sir_novitals(), c(S, I, R), "group") %>% 
  mutate(group = factor(group, levels = c("S", "I", "R")))})

# use out to create dS, dI, dR, and the per capita changes in population
pop_out_sir_novitals <- reactive({
  pop_out <- out_sir_novitals()
  pop_out$dS <- c(NA, diff(pop_out$S))
  pop_out$dI <- c(NA, diff(pop_out$I))
  pop_out$dR <- c(NA, diff(pop_out$R))
  # not using pgrs right now but could be useful to calculate
  pop_out <- pop_out %>% mutate(pgrS = dS/S, pgrI = dI/I, pgrR = dR/R)
  pop_out
})

pop_out_long_sir_novitals <- reactive({ pop_out_sir_novitals() %>%
  select(time, dS, dI, dR) %>%
  pivot_longer(c(dS, dI, dR), "group") %>%
  mutate(group = factor(group, levels = c("dS", "dI", "dR")))
})

# Make plots --------------------


# Plot abundance through time ----------
abund_plot_SIR_novitals <- reactive({ggplot(out_long_sir_novitals()) + 
    geom_line(aes(x = time, y = value, color = group), size = 2) + 
    scale_color_brewer(palette = "Set1") +
    ylab("Population size") + 
    ecoevoapps::theme_apps()
})

# # Plot dS, dI, dR over time
# dabund_plot_SIR_novitals <- reactive({ ggplot(pop_out_long_sir_novitals()) +
#     geom_line(aes(x = time, y = value, color = group), size = 2) +
#     scale_color_brewer(palette = "Set1") +
#     ylab("Change in population size") +
#     ecoevoapps::theme_apps()
# })

# Plot S vs I ---------
SIplot_sir_novitals <- reactive({ggplot(out_sir_novitals()) +
    geom_segment(x = out_sir_novitals()$S[round(length(time_sir_novitals()))/25], 
                 y = out_sir_novitals()$I[round(length(time_sir_novitals()))/25], 
                 xend = out_sir_novitals()$S[round(length(time_sir_novitals())/25) + 1], 
                 yend = out_sir_novitals()$I[round(length(time_sir_novitals())/25) + 1], 
                 arrow = arrow(length = unit(0.15, "npc"))) +
    geom_path(aes(x = S, y = I), size = 2) +
    scale_color_brewer(palette = "Set1") +
    ylab("I size") +
    xlab("S size") +
    ecoevoapps::theme_apps()})

# Plot I vs R --------------
RIplot_sir_novitals <- reactive({ggplot(out_sir_novitals()) +
    geom_segment(x = out_sir_novitals()$R[round(length(time_sir_novitals()))/25], 
                 y = out_sir_novitals()$I[round(length(time_sir_novitals()))/25], 
                 xend = out_sir_novitals()$R[round(length(time_sir_novitals())/25) + 1], 
                 yend = out_sir_novitals()$I[round(length(time_sir_novitals())/25) + 1], 
                 arrow = arrow(length = unit(0.15, "npc"))) +
  geom_path(aes(x = R, y = I), size = 2) +
  scale_color_brewer(palette = "Set1") +
  ylab("I size") +
  xlab("R size") +
  ecoevoapps::theme_apps()})

# Plot S vs R ------------
SRplot_sir_novitals <- reactive({ggplot(out_sir_novitals()) +
    geom_segment(x = out_sir_novitals()$S[round(length(time_sir_novitals()))/25], 
                 y = out_sir_novitals()$R[round(length(time_sir_novitals()))/25], 
                 xend = out_sir_novitals()$S[round(length(time_sir_novitals())/25) + 1], 
                 yend = out_sir_novitals()$R[round(length(time_sir_novitals())/25) + 1], 
                 arrow = arrow(length = unit(0.15, "npc"))) +
  geom_path(aes(x = S, y = R), size = 2) +
  scale_color_brewer(palette = "Set1") +
  ylab("R size") +
  xlab("S size") +
  ecoevoapps::theme_apps()})

# combine 2d plots -----
SIR_2d_plots_novitals <- reactive({
  wrap_plots(SIplot_sir_novitals(), RIplot_sir_novitals(), SRplot_sir_novitals(), ncol = 3)
})


# Make a list of plots and print out plots based on which ones were requested ----

plots_to_render_SIR_sir_novitals <- reactive({
  wrap_plots(abund_plot_SIR_novitals(), 
             # dabund_plot_SIR_novitals(), 
             SIR_2d_plots_novitals(), nrow = 2) 
})


```

### SIS model


\[
\begin{align}
\frac{dS}{dt} &= m(S + I) - mS - \beta SI + \gamma I\\
\frac{dI}{dt} &= \beta SI - mI - \gamma I\\
\end{align}
\]

```{r params SIS, echo=F}
pars_vars <- c("$S$", 
               "$I$", 
               "$m$", 
               "$\\beta$", 
               "$\\gamma$",
               "v")
descriptions <- c("Population size of susceptible individuals",
                 "Population size of infectious individuals",
                 "Birth/death rate",
                 "Infection rate",
                 "Recovery rate",
                 "Newborn vaccination rate")
param_df <- data.frame(pars_vars, descriptions)
kable(x = param_df, format = "html", 
      col.names = c("Parameter/Variable", "Description")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed"),
                position = "center")
```  


```{r sis app, echo=FALSE}
sidebarLayout(
  
  sidebarPanel(
    
    ### Ask user for parameter values ----
    
    #m - death/birth rate
    #beta - infection rate
    #gamma - recovery rate
    
    sliderInput("m_sis", label = "Birth/Death rate:",
                min = 0, max = 1, value = .1, step = 0.1),
    
    sliderInput("beta_sis", label = "Infection rate:",
                min = 0, max = 1, value = .01, step = 0.01),
    
    sliderInput("gamma_sis", label = "Recovery rate:",
                min = 0, max = 1, value = .2, step = 0.1),
    
    
    ### Ask user for initial conditions ----
    numericInput("S0_sis", label = "Initial population size of S", min = 0, value = 100),
    numericInput("I0_sis", label = "Initial population size of I", min = 0, value = 1),
    
    ### Ask user for time to simulate ----
    numericInput("time_sis", label = "Time to simulate", min = 10, value = 100)
    
    
  ),
  
  # Render plots -----------------
  mainPanel(renderPlot({plots_to_render_sis()}, width = 600, height = 800))
  
)


# Run the simulation -------------------

# Set the initial population sizes
init_sis <- reactive({c(S = input$S0_sis, I = input$I0_sis)})
# Set the parameter values
params_sis <- reactive({c(m = input$m_sis, beta = input$beta_sis, gamma = input$gamma_sis)})
# Time over which to simulate model dynamics
time_sis <- reactive({seq(0, input$time_sis, by = .1)})

# Use the SIR function above to run 
# the SIR model using the 
# parameter estimates defined above
out_sis <- reactive({data.frame(deSolve::ode(func = SIS,
                               y = init_sis(), parms = params_sis(), times = time_sis()))})

# Reshape the data so that population sizes of both 
# species are in one column, and an extra column to define
# species name. This helps with the plotting...
out_long_sis <- reactive({pivot_longer(out_sis(), c(S, I), "group") %>% 
  mutate(group = factor(group, levels = c("S", "I")))})

# use out to create dS, dI, dR, and the per capita changes in population
pop_out_sis <- reactive({
  pop_out <- out_sis()
  pop_out$dS <- c(NA, diff(pop_out$S))
  pop_out$dI <- c(NA, diff(pop_out$I))
  # not using pgrs right now but could be useful to calculate
  pop_out <- pop_out %>% mutate(pgrS = dS/S, pgrI = dI/I)
  pop_out
})

pop_out_long_sis <- reactive({ pop_out_sis() %>%
  select(time, dS, dI) %>%
  pivot_longer(c(dS, dI), "group") %>%
  mutate(group = factor(group, levels = c("dS", "dI")))
})

# Make plots --------------------


# Plot abundance through time ----------
abund_plot_sis <- reactive({ggplot(out_long_sis()) + 
    geom_line(aes(x = time, y = value, color = group), size = 2) + 
    scale_color_brewer(palette = "Set1") +
    ylab("Population size") + 
    ecoevoapps::theme_apps()
})

# # Plot dS, dI, dR over time
# dabund_plot_sis <- reactive({ ggplot(pop_out_long_sis()) +
#     geom_line(aes(x = time, y = value, color = group), size = 2) +
#     scale_color_brewer(palette = "Set1") +
#     ylab("Change in population size") +
#     ecoevoapps::theme_apps()
# })

# Plot S vs I ---------
SIplot_sis <- reactive({ggplot(out_sis()) +
    geom_segment(x = out_sis()$S[round(length(time_sis()))/25], 
                 y = out_sis()$I[round(length(time_sis()))/25], 
                 xend = out_sis()$S[round(length(time_sis())/25) + 1], 
                 yend = out_sis()$I[round(length(time_sis())/25) + 1], 
                 arrow = arrow(length = unit(0.15, "npc"))) +
    geom_path(aes(x = S, y = I), size = 2) +
    scale_color_brewer(palette = "Set1") +
    ylab("I size") +
    xlab("S size") +
    ecoevoapps::theme_apps()})



# Make a list of plots and print out plots based on which ones were requested ----

plots_to_render_sis <- reactive({
  wrap_plots(abund_plot_sis(), 
             # dabund_plot_sis(), 
             SIplot_sis(), nrow = 2) 
})


```


### SEIR model

\[
\begin{align}
\frac{dS}{dt} &= m(S + E + I + R)(1 - v) - mS - \beta SI\\
\frac{dE}{dt} &= \beta SI - aE - mE\\
\frac{dI}{dt} &= aE - mI - \gamma I\\
\frac{dR}{dt} &= \gamma I - mR + mv(S + E + I + R)
\end{align}
\]

```{r params SEIR, echo=F}
pars_vars <- c("$S$", 
               "$E$",
               "$I$", 
               "$R$", 
               "$m$", 
               "$\\beta$", 
               "a",
               "$\\gamma$",
               "v")
descriptions <- c("Population size of susceptible individuals",
                  "Population size of exposed (not yet infectious) individuals",
                 "Population size of infectious individuals",
                 "Population size of recovered individuals",
                 "Birth/death rate",
                 "Infection rate",
                 "Inverse of incubation period",
                 "Recovery rate",
                 "Newborn vaccination rate")
param_df <- data.frame(pars_vars, descriptions)
kable(x = param_df, format = "html", 
      col.names = c("Parameter/Variable", "Description")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed"),
                position = "center")
```  


```{r seir app, echo=FALSE}
sidebarLayout(
  
  sidebarPanel(
    
    ### Ask user for parameter values ----
    
    #m - death/birth rate
    #beta - infection rate
    #a - inverse of incubation period
    #gamma - recovery rate
    #v - vaccination rate
    
    sliderInput("m_seir", label = "Birth/Death rate:",
                min = 0, max = 1, value = .1, step = 0.1),
    
    sliderInput("beta_seir", label = "Infection rate:",
                min = 0, max = 1, value = .01, step = 0.01),
    
    sliderInput("a_seir", label = "Inverse of incubation period:",
                min = 0, max = 1, value = 0.05, step = 0.01),
    
    sliderInput("gamma_seir", label = "Recovery rate:",
                min = 0, max = 1, value = .2, step = 0.1),
    
    sliderInput("v_seir", label = "Vaccination rate:",
                min = 0, max = 1, value = 0, step = 0.1),
    
    
    ### Ask user for initial conditions ----
    numericInput("S0_seir", label = "Initial population size of S", min = 0, value = 100),
    numericInput("E0_seir", label = "Initial population size of E", min = 0, value = 0),
    numericInput("I0_seir", label = "Initial population size of I", min = 0, value = 1),
    numericInput("R0_seir", label = "Initial population size of R", min = 0, value = 0),
    
    ### Ask user for time to simulate ----
    numericInput("time_seir", label = "Time to simulate", min = 10, value = 100)
    
    
  ),
  
  # Render plots -----------------
  mainPanel(renderPlot({plots_to_render_seir()}, width = 600, height = 800))
  
)


# Run the simulation -------------------

# Set the initial population sizes
init_seir <- reactive({c(S = input$S0_seir, E = input$E0_seir, I = input$I0_seir, R = input$S0_seir)})
# Set the parameter values
params_seir <- reactive({c(m = input$m_seir, beta = input$beta_seir, a = input$a_seir, gamma = input$gamma_seir, v = input$v_seir)})
# Time over which to simulate model dynamics
time_seir <- reactive({seq(0, input$time_seir, by = .1)})

# Use the SEIR function above to run 
# the SEIR model using the 
# parameter estimates defined above
out_seir <- reactive({data.frame(deSolve::ode(func = SEIR,
                               y = init_seir(), parms = params_seir(), times = time_seir()))})

# Reshape the data so that population sizes of both 
# species are in one column, and an extra column to define
# species name. This helps with the plotting...
out_long_seir <- reactive({pivot_longer(out_seir(), c(S, E, I, R), "group") %>% 
  mutate(group = factor(group, levels = c("S", "E", "I", "R")))})

# use out to create dS, dE, dI, dR, and the per capita changes in population
pop_out_seir <- reactive({
  pop_out <- out_seir()
  pop_out$dS <- c(NA, diff(pop_out$S))
  pop_out$dE <- c(NA, diff(pop_out$E))
  pop_out$dI <- c(NA, diff(pop_out$I))
  pop_out$dR <- c(NA, diff(pop_out$R))
  # not using pgrs right now but could be useful to calculate
  pop_out <- pop_out %>% mutate(pgrS = dS/S, pgrE = dE/E, pgrI = dI/I, pgrR = dR/R)
  pop_out
})

pop_out_long_seir <- reactive({ pop_out_seir() %>%
  select(time, dS, dE, dI, dR) %>%
  pivot_longer(c(dS, dE, dI, dR), "group") %>%
  mutate(group = factor(group, levels = c("dS", "dE", "dI", "dR")))
})

# Make plots --------------------


# Plot abundance through time ----------
abund_plot_seir <- reactive({ggplot(out_long_seir()) + 
    geom_line(aes(x = time, y = value, color = group), size = 2) + 
    scale_color_brewer(palette = "Set1") +
    ylab("Population size") + 
    ecoevoapps::theme_apps()
})

# # Plot dS, dE, dI, dR over time
# dabund_plot_seir <- reactive({ ggplot(pop_out_long_seir()) +
#     geom_line(aes(x = time, y = value, color = group), size = 2) +
#     scale_color_brewer(palette = "Set1") +
#     ylab("Change in population size") +
#     ecoevoapps::theme_apps()
# })

# Plot S vs E ---------
SEplot_seir <- reactive({ggplot(out_seir()) +
    geom_segment(x = out_seir()$S[round(length(time_seir()))/25], 
                 y = out_seir()$E[round(length(time_seir()))/25], 
                 xend = out_seir()$S[round(length(time_seir())/25) + 1], 
                 yend = out_seir()$E[round(length(time_seir())/25) + 1], 
                 arrow = arrow(length = unit(0.15, "npc"))) +
    geom_path(aes(x = S, y = E), size = 2) +
    scale_color_brewer(palette = "Set1") +
    ylab("E size") +
    xlab("S size") +
    ecoevoapps::theme_apps()})

# Plot S vs I ---------
SIplot_seir <- reactive({ggplot(out_seir()) +
    geom_segment(x = out_seir()$S[round(length(time_seir()))/25], 
                 y = out_seir()$I[round(length(time_seir()))/25], 
                 xend = out_seir()$S[round(length(time_seir())/25) + 1], 
                 yend = out_seir()$I[round(length(time_seir())/25) + 1], 
                 arrow = arrow(length = unit(0.15, "npc"))) +
    geom_path(aes(x = S, y = I), size = 2) +
    scale_color_brewer(palette = "Set1") +
    ylab("I size") +
    xlab("S size") +
    ecoevoapps::theme_apps()})

# Plot S vs R ---------
SRplot_seir <- reactive({ggplot(out_seir()) +
    geom_segment(x = out_seir()$S[round(length(time_seir()))/25], 
                 y = out_seir()$R[round(length(time_seir()))/25], 
                 xend = out_seir()$S[round(length(time_seir())/25) + 1], 
                 yend = out_seir()$R[round(length(time_seir())/25) + 1], 
                 arrow = arrow(length = unit(0.15, "npc"))) +
    geom_path(aes(x = S, y = R), size = 2) +
    scale_color_brewer(palette = "Set1") +
    ylab("R size") +
    xlab("S size") +
    ecoevoapps::theme_apps()})

# Plot E vs I ---------
EIplot_seir <- reactive({ggplot(out_seir()) +
    geom_segment(x = out_seir()$E[round(length(time_seir()))/25], 
                 y = out_seir()$I[round(length(time_seir()))/25], 
                 xend = out_seir()$E[round(length(time_seir())/25) + 1], 
                 yend = out_seir()$I[round(length(time_seir())/25) + 1], 
                 arrow = arrow(length = unit(0.15, "npc"))) +
    geom_path(aes(x = E, y = I), size = 2) +
    scale_color_brewer(palette = "Set1") +
    ylab("I size") +
    xlab("E size") +
    ecoevoapps::theme_apps()})

# Plot E vs R ---------
ERplot_seir <- reactive({ggplot(out_seir()) +
    geom_segment(x = out_seir()$E[round(length(time_seir()))/25], 
                 y = out_seir()$R[round(length(time_seir()))/25], 
                 xend = out_seir()$E[round(length(time_seir())/25) + 1], 
                 yend = out_seir()$R[round(length(time_seir())/25) + 1], 
                 arrow = arrow(length = unit(0.15, "npc"))) +
    geom_path(aes(x = E, y = R), size = 2) +
    scale_color_brewer(palette = "Set1") +
    ylab("R size") +
    xlab("E size") +
    ecoevoapps::theme_apps()})

# Plot R vs I ---------
RIplot_seir <- reactive({ggplot(out_seir()) +
    geom_segment(x = out_seir()$R[round(length(time_seir()))/25], 
                 y = out_seir()$I[round(length(time_seir()))/25], 
                 xend = out_seir()$R[round(length(time_seir())/25) + 1], 
                 yend = out_seir()$I[round(length(time_seir())/25) + 1], 
                 arrow = arrow(length = unit(0.15, "npc"))) +
    geom_path(aes(x = R, y = I), size = 2) +
    scale_color_brewer(palette = "Set1") +
    ylab("I size") +
    xlab("R size") +
    ecoevoapps::theme_apps()})

# combine 2d plots -----
SEIR_2d_plots <- reactive({
  wrap_plots(SEplot_seir(), SIplot_seir(), SRplot_seir(), EIplot_seir(), ERplot_seir(), RIplot_seir(), ncol = 3)
})

# Make a list of plots and print out plots based on which ones were requested ----

plots_to_render_seir <- reactive({
  wrap_plots(abund_plot_seir(), 
             # dabund_plot_seir(), 
             SEIR_2d_plots(), nrow = 2) 
})


```

### SIRD model

\[
\begin{align}
\frac{dS}{dt} &= m(S + I + R)(1 - v) - mS - \beta SI\\
\frac{dI}{dt} &= \beta SI - mI - \gamma I - \mu I\\
\frac{dR}{dt} &= \gamma I - mR + mv(S + I + R)\\
\frac{dD}{dt} &= \mu I\\
\end{align}
\]

```{r params SIRD, echo=F}
pars_vars <- c("$S$", 
               "$I$", 
               "$R$", 
               "$D$",
               "$m$", 
               "$\\beta$", 
               "$\\gamma$",
               "$\\mu$",
               "v")
descriptions <- c("Population size of susceptible individuals",
                 "Population size of infectious individuals",
                 "Population size of recovered individuals",
                 "Number of individuals who die due to infection",
                 "Birth/death rate",
                 "Infection rate",
                 "Recovery rate",
                 "Death rate from infection",
                 "Newborn vaccination rate")
param_df <- data.frame(pars_vars, descriptions)
kable(x = param_df, format = "html", 
      col.names = c("Parameter/Variable", "Description")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed"),
                position = "center")
```  


```{r sird app, echo=FALSE}
sidebarLayout(
  
  sidebarPanel(
    
    ### Ask user for parameter values ----
    
    #m - death/birth rate
    #beta - infection rate
    #mu - death rate due to infection
    #gamma - recovery rate
    #v - vaccination rate
    
    sliderInput("m_sird", label = "Birth/Death rate:",
                min = 0, max = 1, value = .1, step = 0.1),
    
    sliderInput("beta_sird", label = "Infection rate:",
                min = 0, max = 1, value = .01, step = 0.01),
    
    sliderInput("gamma_sird", label = "Recovery rate:",
                min = 0, max = 1, value = .2, step = 0.1),
    
    sliderInput("mu_sird", label = "Death rate due to infection:",
                min = 0, max = 1, value = 0.05, step = 0.01),
    
    sliderInput("v_sird", label = "Vaccination rate:",
                min = 0, max = 1, value = 0, step = 0.1),
    
    
    ### Ask user for initial conditions ----
    numericInput("S0_sird", label = "Initial population size of S", min = 0, value = 100),
    numericInput("I0_sird", label = "Initial population size of I", min = 0, value = 1),
    numericInput("R0_sird", label = "Initial population size of R", min = 0, value = 0),
    numericInput("D0_sird", label = "Initial population size of D", min = 0, value = 0),
    
    ### Ask user for time to simulate ----
    numericInput("time_sird", label = "Time to simulate", min = 10, value = 100)
    
    
  ),
  
  # Render plots -----------------
  mainPanel(renderPlot({plots_to_render_sird()}, width = 600, height = 800))
  
)


# Run the simulation -------------------

# Set the initial population sizes
init_sird <- reactive({c(S = input$S0_sird, I = input$I0_sird, R = input$S0_sird, D = input$D0_sird)})
# Set the parameter values
params_sird <- reactive({c(m = input$m_sird, beta = input$beta_sird, mu = input$mu_sird, gamma = input$gamma_sird, v = input$v_sird)})
# Time over which to simulate model dynamics
time_sird <- reactive({seq(0, input$time_sird, by = .1)})

# Use the sird function above to run 
# the sird model using the 
# parameter estimates defined above
out_sird <- reactive({data.frame(deSolve::ode(func = SIRD,
                               y = init_sird(), parms = params_sird(), times = time_sird()))})

# Reshape the data so that population sizes of both 
# species are in one column, and an extra column to define
# species name. This helps with the plotting...
out_long_sird <- reactive({pivot_longer(out_sird(), c(S, I, R, D), "group") %>% 
  mutate(group = factor(group, levels = c("S", "I", "R", "D")))})

# use out to create dS, dD, dI, dR, and the per capita changes in population
pop_out_sird <- reactive({
  pop_out <- out_sird()
  pop_out$dS <- c(NA, diff(pop_out$S))
  pop_out$dI <- c(NA, diff(pop_out$I))
  pop_out$dR <- c(NA, diff(pop_out$R))
  pop_out$dD <- c(NA, diff(pop_out$D))
  # not using pgrs right now but could be useful to calculate
  pop_out <- pop_out %>% mutate(pgrS = dS/S, pgrI = dI/I, pgrR = dR/R, pgrD = dD/D)
  pop_out
})

pop_out_long_sird <- reactive({ pop_out_sird() %>%
  select(time, dS, dI, dR, dD) %>%
  pivot_longer(c(dS, dI, dR, dD), "group") %>%
  mutate(group = factor(group, levels = c("dS", "dI", "dR", "dD")))
})

# Make plots --------------------


# Plot abundance through time ----------
abund_plot_sird <- reactive({ggplot(out_long_sird()) + 
    geom_line(aes(x = time, y = value, color = group), size = 2) + 
    scale_color_brewer(palette = "Set1") +
    ylab("Population size") + 
    ecoevoapps::theme_apps()
})

# # Plot dS, dD, dI, dR over time
# dabund_plot_sird <- reactive({ ggplot(pop_out_long_sird()) +
#     geom_line(aes(x = time, y = value, color = group), size = 2) +
#     scale_color_brewer(palette = "Set1") +
#     ylab("Change in population size") +
#     ecoevoapps::theme_apps()
# })

# Plot S vs D ---------
SDplot_sird <- reactive({ggplot(out_sird()) +
    geom_segment(x = out_sird()$S[round(length(time_sird()))/25], 
                 y = out_sird()$D[round(length(time_sird()))/25], 
                 xend = out_sird()$S[round(length(time_sird())/25) + 1], 
                 yend = out_sird()$D[round(length(time_sird())/25) + 1], 
                 arrow = arrow(length = unit(0.15, "npc"))) +
    geom_path(aes(x = S, y = D), size = 2) +
    scale_color_brewer(palette = "Set1") +
    ylab("D size") +
    xlab("S size") +
    ecoevoapps::theme_apps()})

# Plot S vs I ---------
SIplot_sird <- reactive({ggplot(out_sird()) +
    geom_segment(x = out_sird()$S[round(length(time_sird()))/25], 
                 y = out_sird()$I[round(length(time_sird()))/25], 
                 xend = out_sird()$S[round(length(time_sird())/25) + 1], 
                 yend = out_sird()$I[round(length(time_sird())/25) + 1], 
                 arrow = arrow(length = unit(0.15, "npc"))) +
    geom_path(aes(x = S, y = I), size = 2) +
    scale_color_brewer(palette = "Set1") +
    ylab("I size") +
    xlab("S size") +
    ecoevoapps::theme_apps()})

# Plot S vs R ---------
SRplot_sird <- reactive({ggplot(out_sird()) +
    geom_segment(x = out_sird()$S[round(length(time_sird()))/25], 
                 y = out_sird()$R[round(length(time_sird()))/25], 
                 xend = out_sird()$S[round(length(time_sird())/25) + 1], 
                 yend = out_sird()$R[round(length(time_sird())/25) + 1], 
                 arrow = arrow(length = unit(0.15, "npc"))) +
    geom_path(aes(x = S, y = R), size = 2) +
    scale_color_brewer(palette = "Set1") +
    ylab("R size") +
    xlab("S size") +
    ecoevoapps::theme_apps()})

# Plot D vs I ---------
DIplot_sird <- reactive({ggplot(out_sird()) +
    geom_segment(x = out_sird()$D[round(length(time_sird()))/25], 
                 y = out_sird()$I[round(length(time_sird()))/25], 
                 xend = out_sird()$D[round(length(time_sird())/25) + 1], 
                 yend = out_sird()$I[round(length(time_sird())/25) + 1], 
                 arrow = arrow(length = unit(0.15, "npc"))) +
    geom_path(aes(x = D, y = I), size = 2) +
    scale_color_brewer(palette = "Set1") +
    ylab("I size") +
    xlab("D size") +
    ecoevoapps::theme_apps()})

# Plot D vs R ---------
DRplot_sird <- reactive({ggplot(out_sird()) +
    geom_segment(x = out_sird()$D[round(length(time_sird()))/25], 
                 y = out_sird()$R[round(length(time_sird()))/25], 
                 xend = out_sird()$D[round(length(time_sird())/25) + 1], 
                 yend = out_sird()$R[round(length(time_sird())/25) + 1], 
                 arrow = arrow(length = unit(0.15, "npc"))) +
    geom_path(aes(x = D, y = R), size = 2) +
    scale_color_brewer(palette = "Set1") +
    ylab("R size") +
    xlab("D size") +
    ecoevoapps::theme_apps()})

# Plot R vs I ---------
RIplot_sird <- reactive({ggplot(out_sird()) +
    geom_segment(x = out_sird()$R[round(length(time_sird()))/25], 
                 y = out_sird()$I[round(length(time_sird()))/25], 
                 xend = out_sird()$R[round(length(time_sird())/25) + 1], 
                 yend = out_sird()$I[round(length(time_sird())/25) + 1], 
                 arrow = arrow(length = unit(0.15, "npc"))) +
    geom_path(aes(x = R, y = I), size = 2) +
    scale_color_brewer(palette = "Set1") +
    ylab("I size") +
    xlab("R size") +
    ecoevoapps::theme_apps()})

# combine 2d plots -----
SIRD_2d_plots <- reactive({
  wrap_plots(SIplot_sird(), SRplot_sird(), SDplot_sird(), RIplot_sird(), DIplot_sird(), DRplot_sird(),  ncol = 3)
})

# Make a list of plots and print out plots based on which ones were requested ----

plots_to_render_sird <- reactive({
  wrap_plots(abund_plot_sird(), 
             # dabund_plot_sird(), 
             SIRD_2d_plots(), nrow = 2) 
})


```

